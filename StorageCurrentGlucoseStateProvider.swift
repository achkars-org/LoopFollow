//
//  StorageCurrentGlucoseStateProvider.swift
//  LoopFollow
//
//  Created by Philippe Achkar on 2026-02-24.
//

import Foundation

/// Reads the latest glucose state from LoopFollow’s existing single source of truth.
/// Provider remains source-agnostic (Nightscout vs Dexcom).
struct StorageCurrentGlucoseStateProvider: CurrentGlucoseStateProviding {

    var glucoseMgdl: Double? {
        // Observable.shared.bg.value is raw mg/dL (Int) set by LoopFollow’s BG refresh pipeline.
        let bg = Observable.shared.bg.value
        return bg > 0 ? Double(bg) : nil
    }

    var deltaMgdl: Double? {
        Storage.shared.lastDeltaMgdl.value
    }

    var projectedMgdl: Double? {
        Storage.shared.projectedBgMgdl.value
    }

    var updatedAt: Date? {
        guard let t = Storage.shared.lastBgReadingTimeSeconds.value else { return nil }
        return Date(timeIntervalSince1970: t)
    }

    var trendCode: String? {
        Storage.shared.lastTrendCode.value
    }

    var iob: Double? {
        Storage.shared.lastIOB.value
    }

    var cob: Double? {
        Storage.shared.lastCOB.value
    }
}